<!DOCTYPE html>
<html>
  <head>
    <title>INeedAPrompt</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="styles.css" />
    <base target="_blank" />
    <script src="ineedaprompt.js"></script>
    <script>
var els = {};
var h = (function helpers(){
  var h = {};
  h.el = function(str){
    var e = {}, d = document;
    if(str.charAt(0) === "#") e = d.getElementById(str.substring(1));
    else e = d.querySelectorAll(str);
    if(e instanceof NodeList && e.length === 1) e = e[0];
    return e;
  }
  h.ajax = function(path, callback){
    var http = new XMLHttpRequest();
    http.open("GET", path, true);
    http.onreadystatechange = function(){
      if(this.readyState !== 4 || this.status !== 200) return;
      callback(JSON.parse(this.responseText));
    }
    http.send();
  }
  h.commaNum = function(num){
    if(num.toString().length < 4) return num;
    else return num.toString().split("").reverse().join("").replace(/(.{3})/g, "$1,").split("").reverse().join("");
  }
  h.eachIn = ineedaprompt.helpers.eachIn;
  h.collect = ineedaprompt.helpers.collect;
  return h;
}());
window.onload = function(){

  (function setEls(){
    var elIds = ["newPrompt", "promptNum", "promptOutput", "reddit", "twitter", "promptPlaque", "apiLink"];
    h.eachIn(elIds, function(id){
      els[id] = document.getElementById(id);
    });
  }());

  (function placeDefaultWordTypes(){
    var wordTypes = ineedaprompt.default();
    var container = h.el("#wordTypes")
    h.eachIn(wordTypes, function(type, i){
      var choice = document.createElement("LI");
      var input = document.createElement("INPUT");
      var label = document.createElement("LABEL");
      var id = "choice" + i;
      input.type = "checkbox";
      input.value = type;
      input.id = id;
      if(Math.random() > 0.5) input.checked = true;
      label.textContent = type;
      label.htmlFor = id;
      choice.appendChild(input);
      choice.appendChild(label);
      container.appendChild(choice);
    });
  }());

  (function listenToButton(){
    els.newPrompt.addEventListener("click", loadPrompt);
  }());

  // Fade out text color
  // Load new content
  // Place new content
  // Resize plaque
  // Fade in text color

  loadPrompt();

}

function loadPrompt(){
  var plaque = els.promptPlaque;
  var inputs = h.el("form input");
  var wordOrder = h.collect(inputs, function(input){
    if(input.checked) return input.value;
  });
  var promptUrl = "/api?q=" + wordOrder.join("+");
  els.apiLink.href = promptUrl;
  h.ajax(promptUrl, function(response){
    var queryParam = response.prompt.replace(/ /g, "+");
    els.promptNum.textContent = h.commaNum(response.count);
    els.promptOutput.textContent = response.prompt;
    els.reddit.href = "https://www.reddit.com/r/ineedaprompt/submit?selftext=true&title=" + queryParam;
    els.twitter.href = "https://twitter.com/intent/tweet?text=%23ineedaprompt%20" + queryParam;
    plaque.className = "plaque on";
  });
}
    </script>
  </head>
  <body>
    <main>
      <form>
        <h1 id="newPrompt"><button type="button">I need a prompt!</button></h1>
        <ul id="wordTypes" class="links"></ul>
      </form>
      <div class="plaque" id="promptPlaque">
        <h2>Prompt &num;<span id="promptNum">1</span></h2>
        <blockquote id="promptOutput"></blockquote>
        <aside><a id="reddit">Post to /r/ineedaprompt</a><a id="twitter">Tweet it: &num;ineedaprompt</a></aside>
      </div>
      <div>
      </div>
    </main>
    <footer>
      <ul class="links">
        <li><a id="apiLink" href="/api">API</a></li>
        <li><a href="dictionary.json">Dictionary</a></li>
        <li><a href="http://github.com/robertakarobin/inap-node">Github</a></li>
        <li><a href="http://robertakarobin.com">RobertAKARobin</a></li>
      </ul>
    </footer>
  </body>
</html>
